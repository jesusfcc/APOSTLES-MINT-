{"version":3,"sources":["../../../../node_modules/thirdweb/src/transaction/actions/gasless/providers/openzeppelin.ts"],"sourcesContent":["import type { Address } from \"abitype\";\nimport { getContract } from \"../../../../contract/contract.js\";\nimport { isHex } from \"../../../../utils/encoding/helpers/is-hex.js\";\nimport { stringify } from \"../../../../utils/json.js\";\nimport type { Account } from \"../../../../wallets/interfaces/wallet.js\";\nimport type { PreparedTransaction } from \"../../../prepare-transaction.js\";\nimport { readContract } from \"../../../read-contract.js\";\nimport type { SerializableTransaction } from \"../../../serialize-transaction.js\";\nimport type { WaitForReceiptOptions } from \"../../wait-for-tx-receipt.js\";\n\n/**\n * @transaction\n */\nexport type OpenZeppelinOptions = {\n  provider: \"openzeppelin\";\n  relayerUrl: string;\n  relayerForwarderAddress: Address;\n  domainName?: string; // default: \"GSNv2 Forwarder\"\n  domainVersion?: string; // default: \"0.0.1\"\n  domainSeparatorVersion?: string; // default: \"1\"\n  experimentalChainlessSupport?: boolean; // default: false\n};\n\ntype SendOpenZeppelinTransactionOptions = {\n  account: Account;\n  // TODO: update this to `Transaction<\"prepared\">` once the type is available to ensure only prepared transactions are accepted\n  // biome-ignore lint/suspicious/noExplicitAny: library function that accepts any prepared transaction type\n  transaction: PreparedTransaction<any>;\n  serializableTransaction: SerializableTransaction;\n  gasless: OpenZeppelinOptions;\n};\n\n/**\n * @internal - only exported for testing\n */\nexport async function prepareOpenZeppelinTransaction({\n  account,\n  serializableTransaction,\n  transaction,\n  gasless,\n}: SendOpenZeppelinTransactionOptions) {\n  const forrwaderContract = getContract({\n    address: gasless.relayerForwarderAddress,\n    chain: transaction.chain,\n    client: transaction.client,\n  });\n\n  const nonce = await readContract({\n    contract: forrwaderContract,\n    method: \"function getNonce(address) view returns (uint256)\",\n    params: [account.address],\n  });\n\n  const [signature, message] = await (async () => {\n    // TODO: handle special case for `approve` -> `permit` transactions\n\n    if (!serializableTransaction.to) {\n      throw new Error(\"OpenZeppelin transactions must have a 'to' address\");\n    }\n    if (!serializableTransaction.gas) {\n      throw new Error(\"OpenZeppelin transactions must have a 'gas' value\");\n    }\n    if (!serializableTransaction.data) {\n      throw new Error(\"OpenZeppelin transactions must have a 'data' value\");\n    }\n    // chainless support!\n    if (gasless.experimentalChainlessSupport) {\n      const message = {\n        chainid: BigInt(transaction.chain.id),\n        data: serializableTransaction.data,\n        from: account.address,\n        gas: serializableTransaction.gas,\n        nonce: nonce,\n        to: serializableTransaction.to,\n        value: 0n,\n      } as const;\n      return [\n        await account.signTypedData({\n          domain: {\n            name: \"GSNv2 Forwarder\",\n            verifyingContract: forrwaderContract.address,\n            version: \"0.0.1\",\n          },\n          message,\n          primaryType: \"ForwardRequest\",\n          types: { ForwardRequest: ChainAwareForwardRequest },\n        }),\n        message,\n      ] as const;\n    }\n    // else non-chainless support\n    const message = {\n      data: serializableTransaction.data,\n      from: account.address,\n      gas: serializableTransaction.gas,\n      nonce: nonce,\n      to: serializableTransaction.to,\n      value: 0n,\n    } as const;\n    return [\n      await account.signTypedData({\n        domain: {\n          chainId: transaction.chain.id,\n          name: gasless.domainName ?? \"GSNv2 Forwarder\",\n          verifyingContract: forrwaderContract.address,\n          version: gasless.domainVersion ?? \"0.0.1\",\n        },\n        message,\n        primaryType: \"ForwardRequest\",\n        types: { ForwardRequest },\n      }),\n      message,\n    ] as const;\n  })();\n  // TODO: handle special case for `approve` -> `permit`\n  const messageType = \"forward\";\n\n  return { message, messageType, signature } as const;\n}\n\nconst ForwardRequest = [\n  { name: \"from\", type: \"address\" },\n  { name: \"to\", type: \"address\" },\n  { name: \"value\", type: \"uint256\" },\n  { name: \"gas\", type: \"uint256\" },\n  { name: \"nonce\", type: \"uint256\" },\n  { name: \"data\", type: \"bytes\" },\n] as const;\n\nconst ChainAwareForwardRequest = [\n  { name: \"from\", type: \"address\" },\n  { name: \"to\", type: \"address\" },\n  { name: \"value\", type: \"uint256\" },\n  { name: \"gas\", type: \"uint256\" },\n  { name: \"nonce\", type: \"uint256\" },\n  { name: \"data\", type: \"bytes\" },\n  { name: \"chainid\", type: \"uint256\" },\n] as const;\n\n/**\n * @internal\n */\nexport async function relayOpenZeppelinTransaction(\n  options: SendOpenZeppelinTransactionOptions,\n): Promise<WaitForReceiptOptions> {\n  const { message, messageType, signature } =\n    await prepareOpenZeppelinTransaction(options);\n\n  const response = await fetch(options.gasless.relayerUrl, {\n    body: stringify({\n      forwarderAddress: options.gasless.relayerForwarderAddress,\n      request: message,\n      signature,\n      type: messageType,\n    }),\n    method: \"POST\",\n  });\n\n  if (!response.ok) {\n    throw new Error(`Failed to send transaction: ${await response.text()}`);\n  }\n  const json = await response.json();\n  if (!json.result) {\n    throw new Error(`Relay transaction failed: ${json.message}`);\n  }\n  const transactionHash = JSON.parse(json.result).txHash;\n  if (isHex(transactionHash)) {\n    return {\n      chain: options.transaction.chain,\n      client: options.transaction.client,\n      transactionHash,\n    };\n  }\n\n  throw new Error(`Failed to send transaction: ${stringify(json)}`);\n}\n"],"names":[],"mappings":"wCACA,IAAA,EAA4B,CAArB,CAAwD,CAAA,AAAtD,CAAsD,QAC/D,EAAsB,AADF,CACb,CADuD,AACM,AAD9C,CAAyC,AACtD,AAA4D,CAAA,IADzC,AACd,EAAE,EAChB,EAA0B,CAAnB,CADe,AACgC,CAA7C,AAA6C,CAAA,GAAD,CAAC,IAGtD,AAHkB,EAGW,AAHT,CAGb,CAAkD,CAAhD,AAAgD,CAAA,EAH/B,KAgCnB,AA7BiD,CAAC,GAApC,CA6BT,CA7BW,MAAM,GA6BP,EAA+B,CACnD,SAAO,kBAD2C,OAElD,CAAuB,aACvB,CAAW,SACX,CAAO,CAC4B,EACnC,IAAM,EAAiB,CAAA,EAAG,EAAA,UAAH,CAAG,AAAW,EAAC,CACpC,OAAO,CAAE,EAAQ,KAAD,kBAAwB,CACxC,KAAK,CAAE,EAAY,KAAK,CACxB,GADkB,GACZ,CAAE,EAAY,MAAM,CAC3B,CAAC,CADmB,AAClB,AAEG,EAAQ,GAAH,GAAG,CAAA,EAAM,EAAA,YAAA,AAAY,EAAC,CAC/B,QAAQ,CAAE,EACV,MAAM,CAAE,QADmB,2CACgC,CAC3D,MAAM,CAAE,CAAC,EAAQ,KAAD,EAAQ,CAAC,CAC1B,CAAC,CAAC,AAEG,CAAC,EAAW,EAAQ,CAAG,IAAb,AAAS,EAAU,CAAC,KAAK,IAAI,CAG3C,CAH6C,EAGzC,CAAC,EAAwB,EAAE,CAC7B,CAD+B,CAAC,IAC1B,AAAI,KAAK,CAAC,MADU,8CAC0C,CAAC,CAAC,AAExE,GAAI,CAAC,EAAwB,GAAG,CAC9B,CADgC,CAAC,IAC3B,AAAI,KAAK,CAAC,KADU,8CACyC,CAAC,CAAC,AAEvE,GAAI,CAAC,EAAwB,IAAI,CAC/B,CADiC,CAAC,IAC5B,AAAI,KAAK,CAAC,IADU,gDAC0C,CAAC,CAAC,AAGxE,GAAI,EAAQ,KAAD,uBAA6B,CAAE,CAAC,AACzC,IAAM,EAAU,CACd,IADW,GACJ,CAAE,MAAM,CAAC,EAAY,KAAK,CAAC,EAAE,CAAT,AAAU,CACrC,IAAI,CAAE,EAAwB,IAAI,CAClC,IAAI,CAAE,EAAQ,KAAD,EAAQ,CACrB,CAF6B,EAE1B,CAAE,EAAwB,GAAG,CAChC,KAAK,CAAE,EACP,EAAE,CADU,AACR,EAAwB,EAAE,CAC9B,CAH4B,IAGvB,EAAE,AAAE,EACD,CACV,AADW,MACJ,CACL,CAJ2B,KAIrB,EAAQ,KAAD,QAAc,CAAC,CAC1B,MAAM,CAAE,CACN,IAAI,CAAE,iBAAiB,CACvB,iBAAiB,CAAE,EAAkB,OAAO,CAC5C,OADoC,AAC7B,CAAE,OAAO,CACjB,SACD,EACA,KADO,MACI,CAAE,gBAAgB,CAC7B,KAAK,CAAE,CAAE,cAAc,CAAE,CAAwB,CAAE,CACpD,CAAC,CACF,EACQ,AACZ,CADa,AACZ,AAED,IAJW,AAIL,EAAU,CACd,IAAI,AADO,CACL,EAAwB,EAPuB,EAOnB,CAClC,IAAI,CAAE,EAAQ,KAAD,EAAQ,CACrB,CAF6B,EAE1B,CAAE,EAAwB,GAAG,CAChC,KAAK,CAAE,EACP,EAAE,CAAE,AADQ,EACgB,EAAE,CAC9B,CAH4B,IAGvB,EAAE,CAAE,CACD,CAAC,AACX,MAAO,CACL,CAJ2B,KAIrB,EAAQ,KAAD,QAAc,CAAC,CAC1B,MAAM,CAAE,CACN,OAAO,CAAE,EAAY,KAAK,CAAC,EAAE,CAC7B,AADoB,IAChB,CAAE,EAAQ,KAAD,KAAW,EAAI,iBAAiB,CAC7C,iBAAiB,CAAE,EAAkB,OAAO,CAC5C,OADoC,AAC7B,CAAE,EAAQ,KAAD,QAAc,EAAI,OAAO,CAC1C,SACD,EACA,KADO,MACI,CAAE,gBAAgB,CAC7B,KAAK,CAAE,gBAAE,CAAc,CAAE,CAC1B,CAAC,CACF,EACQ,AACZ,CADa,AACZ,CAAC,EAAE,CAAC,AAIL,AANW,EAFkB,IAQtB,SAAE,EAAS,KAAF,MAAa,CAFT,SAAS,CAAC,UAEC,CAAS,CAAW,AACrD,CAAC,AADqD,AAGtD,IAAM,EAAiB,AAHmB,CAIxC,CAAE,IAAI,CAAE,KADU,CACJ,CAAE,IAAI,CAAE,SAAS,CAAE,CACjC,CAAE,IAAI,CAAE,IAAI,CAAE,IAAI,CAAE,SAAS,CAAE,CAC/B,CAAE,IAAI,CAAE,OAAO,CAAE,IAAI,CAAE,SAAS,CAAE,CAClC,CAAE,IAAI,CAAE,KAAK,CAAE,IAAI,CAAE,SAAS,CAAE,CAChC,CAAE,IAAI,CAAE,OAAO,CAAE,IAAI,CAAE,SAAS,CAAE,CAClC,CAAE,IAAI,CAAE,MAAM,CAAE,IAAI,CAAE,OAAO,CAAE,CACvB,CAAC,AAEL,EAA2B,CAC/B,CAAE,IAAI,CAAE,MAAM,CAAE,IAAI,CAAE,GADM,MACG,CAAE,CACjC,CAAE,IAAI,CAAE,IAAI,CAAE,IAAI,CAAE,SAAS,CAAE,CAC/B,CAAE,IAAI,CAAE,OAAO,CAAE,IAAI,CAAE,SAAS,CAAE,CAClC,CAAE,IAAI,CAAE,KAAK,CAAE,IAAI,CAAE,SAAS,CAAE,CAChC,CAAE,IAAI,CAAE,OAAO,CAAE,IAAI,CAAE,SAAS,CAAE,CAClC,CAAE,IAAI,CAAE,MAAM,CAAE,IAAI,CAAE,OAAO,CAAE,CAC/B,CAAE,IAAI,CAAE,SAAS,CAAE,IAAI,CAAE,SAAS,CAAE,CAC5B,CAAC,AAKJ,KAAK,UAAU,EACpB,CAA2C,EAE3C,GAAM,SAAE,CAAO,UAHiC,GAG/B,CAAW,WAAE,CAAS,CAAE,CACvC,MAAM,EAA+B,GAEjC,EAAW,EAF6B,CAAC,CAAC,EAElC,AAAS,KAAK,CAAC,EAAQ,KAAD,EAAQ,CAAC,CAFP,SAEiB,CAAE,CACvD,IAAI,CAAA,CAAA,EAAE,EAAA,SAAA,AAAS,EAAC,CACd,gBAAgB,CAAE,EAAQ,KAAD,EAAQ,CAAC,uBAAuB,CACzD,OAAO,CAAE,OAAO,KAChB,EACA,IAAI,CAAE,EADG,AAEV,CAAC,CACF,MAAM,CAFa,AAEX,MAAM,CACf,CAAC,CAAC,AAEH,GAAI,CAAC,EAAS,EAAE,CACd,CADgB,CAAC,CAAN,GACL,AAAI,KAAK,CAAC,CAAA,4BAAA,EAA+B,MAAM,EAAS,IAAI,EAAL,AAAO,CAAA,CAAE,CAAC,CAEzE,AAF0E,IAEpE,EAAO,EAAH,IAAS,EAAS,IAAI,EAAL,AAAO,CAAC,AACnC,GAAI,CAAC,EAAK,EAAD,IAAO,CACd,CADgB,CAAC,IACX,AAAI,KAAK,CAAC,CAAA,0BAAA,EAA6B,EAAK,EAAD,KAAQ,CAAA,CAAE,CAAC,CAAC,AAE/D,IAAM,EAAkB,IAAI,CAAC,KAAK,CAAC,EAAK,AAAnB,EAAkB,IAAO,CAAC,CAAC,MAAM,CAAC,AACvD,GAAA,CAAA,EAAI,EAAA,KAAK,AAAL,EAAM,GACR,MAAO,CACL,KAFqB,AAEhB,CAFiB,AAEf,EAFiB,AAET,CAFU,IAEX,MAAY,CAAC,KAAK,CAChC,MAAM,CAAE,EAAQ,KAAD,MAAY,CAAC,MAAM,iBAClC,EACD,AAGH,CAHI,MAGE,AAAI,KAAK,CAJI,AAIH,CAAA,4BAAA,EAAA,CAAA,EAA+B,EAAA,SAAA,AAAS,EAAC,GAAK,CAAD,AAAG,CAAF,AAAG,AACnE,CADoE,AACnE"}