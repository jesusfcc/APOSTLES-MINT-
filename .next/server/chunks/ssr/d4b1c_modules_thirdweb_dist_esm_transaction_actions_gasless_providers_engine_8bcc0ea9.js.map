{"version":3,"sources":["../../../../node_modules/thirdweb/src/transaction/actions/gasless/providers/engine.ts"],"sourcesContent":["import type { Address } from \"abitype\";\nimport { getContract } from \"../../../../contract/contract.js\";\nimport { stringify } from \"../../../../utils/json.js\";\nimport type { Account } from \"../../../../wallets/interfaces/wallet.js\";\nimport type { PreparedTransaction } from \"../../../prepare-transaction.js\";\nimport { readContract } from \"../../../read-contract.js\";\nimport type { SerializableTransaction } from \"../../../serialize-transaction.js\";\nimport {\n  type WaitForReceiptOptions,\n  waitForReceipt,\n} from \"../../wait-for-tx-receipt.js\";\n\n/**\n * @transaction\n */\nexport type EngineOptions = {\n  provider: \"engine\";\n  relayerUrl: string;\n  relayerForwarderAddress: Address;\n  domainName?: string; // default: \"GSNv2 Forwarder\"\n  domainVersion?: string; // default: \"0.0.1\"\n  domainSeparatorVersion?: string; // default: \"1\"\n  experimentalChainlessSupport?: boolean; // default: false\n};\n\ntype SendengineTransactionOptions = {\n  account: Account;\n  // TODO: update this to `Transaction<\"prepared\">` once the type is available to ensure only prepared transactions are accepted\n  // biome-ignore lint/suspicious/noExplicitAny: library function that accepts any prepared transaction type\n  transaction: PreparedTransaction<any>;\n  serializableTransaction: SerializableTransaction;\n  gasless: EngineOptions;\n};\n\n/**\n * @internal - only exported for testing\n */\nexport async function prepareEngineTransaction({\n  account,\n  serializableTransaction,\n  transaction,\n  gasless,\n}: SendengineTransactionOptions) {\n  const forrwaderContract = getContract({\n    address: gasless.relayerForwarderAddress,\n    chain: transaction.chain,\n    client: transaction.client,\n  });\n\n  const nonce = await readContract({\n    contract: forrwaderContract,\n    method: \"function getNonce(address) view returns (uint256)\",\n    params: [account.address],\n  });\n\n  const [signature, message] = await (async () => {\n    // TODO: handle special case for `approve` -> `permit` transactions\n\n    if (!serializableTransaction.to) {\n      throw new Error(\"engine transactions must have a 'to' address\");\n    }\n    if (!serializableTransaction.gas) {\n      throw new Error(\"engine transactions must have a 'gas' value\");\n    }\n    if (!serializableTransaction.data) {\n      throw new Error(\"engine transactions must have a 'data' value\");\n    }\n    // chainless support!\n    if (gasless.experimentalChainlessSupport) {\n      const message = {\n        chainid: BigInt(transaction.chain.id),\n        data: serializableTransaction.data,\n        from: account.address,\n        gas: serializableTransaction.gas,\n        nonce: nonce,\n        to: serializableTransaction.to,\n        value: 0n,\n      } as const;\n      return [\n        await account.signTypedData({\n          domain: {\n            name: \"GSNv2 Forwarder\",\n            verifyingContract: forrwaderContract.address,\n            version: \"0.0.1\",\n          },\n          message,\n          primaryType: \"ForwardRequest\",\n          types: { ForwardRequest: ChainAwareForwardRequest },\n        }),\n        message,\n      ] as const;\n    }\n    // else non-chainless support\n    const message = {\n      data: serializableTransaction.data,\n      from: account.address,\n      gas: serializableTransaction.gas,\n      nonce: nonce,\n      to: serializableTransaction.to,\n      value: 0n,\n    } as const;\n    return [\n      await account.signTypedData({\n        domain: {\n          chainId: transaction.chain.id,\n          name: gasless.domainName ?? \"GSNv2 Forwarder\",\n          verifyingContract: forrwaderContract.address,\n          version: gasless.domainVersion ?? \"0.0.1\",\n        },\n        message,\n        primaryType: \"ForwardRequest\",\n        types: { ForwardRequest },\n      }),\n      message,\n    ] as const;\n  })();\n  // TODO: handle special case for `approve` -> `permit`\n  const messageType = \"forward\";\n\n  return { message, messageType, signature } as const;\n}\n\nconst ForwardRequest = [\n  { name: \"from\", type: \"address\" },\n  { name: \"to\", type: \"address\" },\n  { name: \"value\", type: \"uint256\" },\n  { name: \"gas\", type: \"uint256\" },\n  { name: \"nonce\", type: \"uint256\" },\n  { name: \"data\", type: \"bytes\" },\n] as const;\n\nconst ChainAwareForwardRequest = [\n  { name: \"from\", type: \"address\" },\n  { name: \"to\", type: \"address\" },\n  { name: \"value\", type: \"uint256\" },\n  { name: \"gas\", type: \"uint256\" },\n  { name: \"nonce\", type: \"uint256\" },\n  { name: \"data\", type: \"bytes\" },\n  { name: \"chainid\", type: \"uint256\" },\n] as const;\n\n/**\n * @internal\n */\nexport async function relayEngineTransaction(\n  options: SendengineTransactionOptions,\n): Promise<WaitForReceiptOptions> {\n  const { message, messageType, signature } =\n    await prepareEngineTransaction(options);\n\n  const response = await fetch(options.gasless.relayerUrl, {\n    body: stringify({\n      forwarderAddress: options.gasless.relayerForwarderAddress,\n      request: message,\n      signature,\n      type: messageType,\n    }),\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    method: \"POST\",\n  });\n\n  if (!response.ok) {\n    throw new Error(`Failed to send transaction: ${await response.text()}`);\n  }\n  const json = await response.json();\n  if (!json.result) {\n    throw new Error(`Relay transaction failed: ${json.message}`);\n  }\n  const queueId = json.result.queueId;\n  // poll for transactionHash\n  const timeout = 60000;\n  const interval = 1000;\n  const endtime = Date.now() + timeout;\n  while (Date.now() < endtime) {\n    const receipt = await fetchReceipt({ options, queueId });\n    if (receipt) {\n      return {\n        chain: options.transaction.chain,\n        client: options.transaction.client,\n        transactionHash: receipt.transactionHash,\n      };\n    }\n    await new Promise((resolve) => setTimeout(resolve, interval));\n  }\n  throw new Error(`Failed to find relayed transaction after ${timeout}ms`);\n}\n\nasync function fetchReceipt(args: {\n  options: SendengineTransactionOptions;\n  queueId: string;\n}) {\n  const { options, queueId } = args;\n  const url = options.gasless.relayerUrl.split(\"/relayer/\")[0];\n  const res = await fetch(`${url}/transaction/status/${queueId}`, {\n    method: \"GET\",\n  });\n  const resJson = await res.json();\n  if (!res.ok) {\n    return null;\n  }\n  const result = resJson.result;\n  if (!result) {\n    return null;\n  }\n  switch (result.status) {\n    case \"errored\":\n      throw new Error(\n        `Transaction errored with reason: ${result.errorMessage}`,\n      );\n    case \"cancelled\":\n      throw new Error(\"Transaction execution cancelled.\");\n    case \"mined\": {\n      const receipt = await waitForReceipt({\n        chain: options.transaction.chain,\n        client: options.transaction.client,\n        transactionHash: result.transactionHash,\n      });\n      return receipt;\n    }\n    default: {\n      return null;\n    }\n  }\n}\n"],"names":[],"mappings":"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"}