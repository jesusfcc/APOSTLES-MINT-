{"version":3,"sources":["../../../../node_modules/thirdweb/src/transaction/actions/gasless/providers/biconomy.ts"],"sourcesContent":["import type { Address } from \"abitype\";\nimport { encodeAbiParameters } from \"viem\";\nimport { ZERO_ADDRESS } from \"../../../../constants/addresses.js\";\nimport { getContract } from \"../../../../contract/contract.js\";\nimport { getAddress } from \"../../../../utils/address.js\";\nimport { isHex } from \"../../../../utils/encoding/helpers/is-hex.js\";\nimport { keccak256 } from \"../../../../utils/hashing/keccak256.js\";\nimport { stringify } from \"../../../../utils/json.js\";\nimport type { Account } from \"../../../../wallets/interfaces/wallet.js\";\nimport type { PreparedTransaction } from \"../../../prepare-transaction.js\";\nimport { readContract } from \"../../../read-contract.js\";\nimport type { SerializableTransaction } from \"../../../serialize-transaction.js\";\nimport type { WaitForReceiptOptions } from \"../../wait-for-tx-receipt.js\";\n\n/**\n * @transaction\n */\nexport type BiconomyOptions = {\n  provider: \"biconomy\";\n  // you can find the correct forwarder for your network here: https://docs-gasless.biconomy.io/misc/contract-addresses\n  relayerForwarderAddress: Address;\n  apiId: string;\n  apiKey: string;\n  deadlineSeconds?: number; // default: 3600\n};\n\ntype SendBiconomyTransactionOptions = {\n  account: Account;\n  // TODO: update this to `Transaction<\"prepared\">` once the type is available to ensure only prepared transactions are accepted\n  // biome-ignore lint/suspicious/noExplicitAny: library function that accepts any prepared transaction type\n  transaction: PreparedTransaction<any>;\n  serializableTransaction: SerializableTransaction;\n  gasless: BiconomyOptions;\n};\n\n// we do not send multiple batches so this stays consistent\nconst BATCH_ID = 0n;\n\n/**\n * @internal - only exported for testing\n */\nexport async function prepareBiconomyTransaction({\n  account,\n  serializableTransaction,\n  transaction,\n  gasless,\n}: SendBiconomyTransactionOptions) {\n  const forwarderContract = getContract({\n    address: gasless.relayerForwarderAddress,\n    chain: transaction.chain,\n    client: transaction.client,\n  });\n\n  // get the nonce\n  const nonce = await readContract({\n    contract: forwarderContract,\n    method: \"function getNonce(address,uint256) view returns (uint256)\",\n    params: [account.address, BATCH_ID],\n  });\n\n  const deadline =\n    Math.floor(Date.now() / 1000) + (gasless.deadlineSeconds ?? 3600);\n\n  const request = {\n    batchId: BATCH_ID,\n    batchNonce: nonce,\n    data: serializableTransaction.data,\n    deadline: deadline,\n    from: account.address,\n    to: serializableTransaction.to,\n    token: ZERO_ADDRESS,\n    tokenGasPrice: 0n,\n    txGas: serializableTransaction.gas,\n  };\n\n  if (!request.to) {\n    throw new Error(\"Cannot send a transaction without a `to` address\");\n  }\n  if (!request.txGas) {\n    throw new Error(\"Cannot send a transaction without a `gas` value\");\n  }\n  if (!request.data) {\n    throw new Error(\"Cannot send a transaction without a `data` value\");\n  }\n\n  // create the hash\n  const message = encodeAbiParameters(\n    [\n      { type: \"address\" },\n      { type: \"address\" },\n      { type: \"address\" },\n      { type: \"uint256\" },\n      { type: \"uint256\" },\n      { type: \"uint256\" },\n      { type: \"uint256\" },\n      { type: \"bytes32\" },\n    ],\n    [\n      getAddress(request.from),\n      getAddress(request.to),\n      getAddress(request.token),\n      request.txGas,\n      request.tokenGasPrice,\n      request.batchId,\n      request.batchNonce,\n      keccak256(request.data),\n    ],\n  );\n\n  const signature = await account.signMessage({ message });\n\n  return [request, signature] as const;\n}\n\n/**\n * @internal\n */\nexport async function relayBiconomyTransaction(\n  options: SendBiconomyTransactionOptions,\n): Promise<WaitForReceiptOptions> {\n  const [request, signature] = await prepareBiconomyTransaction(options);\n\n  // send the transaction to the biconomy api\n  const response = await fetch(\n    \"https://api.biconomy.io/api/v2/meta-tx/native\",\n    {\n      body: stringify({\n        apiId: options.gasless.apiId,\n        from: request.from,\n        gasLimit: request.txGas,\n        params: [request, signature],\n        to: request.to,\n      }),\n      headers: {\n        \"Content-Type\": \"application/json;charset=utf-8\",\n        \"x-api-key\": options.gasless.apiKey,\n      },\n      method: \"POST\",\n    },\n  );\n  if (!response.ok) {\n    throw new Error(`Failed to send transaction: ${await response.text()}`);\n  }\n  const json = await response.json();\n  const transactionHash = json.txHash;\n  if (isHex(transactionHash)) {\n    return {\n      chain: options.transaction.chain,\n      client: options.transaction.client,\n      transactionHash: transactionHash,\n    };\n  }\n  throw new Error(`Failed to send transaction: ${stringify(json)}`);\n}\n"],"names":[],"mappings":"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"}