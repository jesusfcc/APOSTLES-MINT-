{"version":3,"sources":["../../../../node_modules/thirdweb/src/wallets/wallet-connect/receiver/session-proposal.ts"],"sourcesContent":["import type { Chain } from \"../../../chains/types.js\";\nimport type { Account, Wallet } from \"../../interfaces/wallet.js\";\nimport { disconnectWalletConnectSession } from \"./index.js\";\nimport { getSessions, saveSession } from \"./session-store.js\";\nimport type {\n  WalletConnectClient,\n  WalletConnectSession,\n  WalletConnectSessionProposalEvent,\n} from \"./types.js\";\n\n/**\n * @internal\n */\nexport async function onSessionProposal(options: {\n  wallet: Wallet;\n  walletConnectClient: WalletConnectClient;\n  event: WalletConnectSessionProposalEvent;\n  chains?: Chain[];\n  onConnect?: (session: WalletConnectSession) => void;\n}) {\n  const { wallet, walletConnectClient, event, chains, onConnect } = options;\n\n  const account = wallet.getAccount();\n  if (!account) {\n    throw new Error(\"No account connected to provided wallet\");\n  }\n\n  const origin = event.verifyContext?.verified?.origin;\n  if (origin) {\n    await disconnectExistingSessions({ origin, walletConnectClient });\n  }\n  const session = await acceptSessionProposal({\n    account,\n    chains,\n    sessionProposal: event,\n    walletConnectClient,\n  });\n\n  await saveSession(session);\n\n  wallet.subscribe(\"disconnect\", () => {\n    disconnectWalletConnectSession({ session, walletConnectClient });\n  });\n\n  onConnect?.(session);\n}\n\n/**\n * @internal\n */\nexport async function disconnectExistingSessions({\n  walletConnectClient,\n  origin,\n}: {\n  walletConnectClient: WalletConnectClient;\n  origin: string;\n}) {\n  const sessions = await getSessions();\n  for (const session of sessions) {\n    if (session.origin === origin) {\n      await disconnectWalletConnectSession({ session, walletConnectClient });\n    }\n  }\n}\n\n/**\n * @internal\n */\nexport async function acceptSessionProposal({\n  account,\n  walletConnectClient,\n  sessionProposal,\n  chains,\n}: {\n  account: Account;\n  walletConnectClient: WalletConnectClient;\n  sessionProposal: WalletConnectSessionProposalEvent;\n  chains?: Chain[];\n}): Promise<WalletConnectSession> {\n  if (\n    !sessionProposal.params.requiredNamespaces?.eip155 &&\n    !sessionProposal.params.optionalNamespaces?.eip155\n  ) {\n    throw new Error(\n      \"No EIP155 namespace found in Wallet Connect session proposal\",\n    );\n  }\n\n  const namespaces = {\n    chains: [\n      ...Array.from(\n        new Set([\n          ...(sessionProposal.params.requiredNamespaces?.eip155?.chains?.map(\n            (chain: string) => `${chain}:${account.address}`,\n          ) ?? []),\n          ...(sessionProposal.params.optionalNamespaces?.eip155?.chains?.map(\n            (chain: string) => `${chain}:${account.address}`,\n          ) ?? []),\n          ...(chains?.map((chain) => `eip155:${chain.id}:${account.address}`) ??\n            []),\n        ]),\n      ),\n    ],\n    events: [\n      ...(sessionProposal.params.requiredNamespaces?.eip155?.events ?? []),\n      ...(sessionProposal.params.optionalNamespaces?.eip155?.events ?? []),\n    ],\n    methods: [\n      ...(sessionProposal.params.requiredNamespaces?.eip155?.methods ?? []),\n      ...(sessionProposal.params.optionalNamespaces?.eip155?.methods ?? []),\n    ],\n  };\n  const approval = await walletConnectClient.approve({\n    id: sessionProposal.id,\n    namespaces: {\n      eip155: {\n        accounts: namespaces.chains,\n        events: namespaces.events,\n        methods: namespaces.methods,\n      },\n    },\n  });\n\n  const session = await approval.acknowledged();\n  return {\n    origin: sessionProposal.verifyContext?.verified?.origin || \"Unknown origin\",\n    topic: session.topic,\n  };\n}\n"],"names":[],"mappings":"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"}